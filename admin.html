<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Stree Shakti Sanghatan</title>

    <link rel="stylesheet" href="dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>

<body>

<!-- ADMIN AUTH CHECK -->
<script>
const user = JSON.parse(localStorage.getItem("user") || "null");

console.log("User from localStorage on admin page:", user);

if (!user || !user.isAdmin) {
    alert("Access denied");
    window.location.href = "login.html";
}
</script>

<!-- Sidebar -->
<aside class="sidebar">
    <div class="logo-box">
        <span class="heart"><img class="logo" src="logo pink.png" alt=""></span>
        <h2>Stree Shakti</h2>
    </div>

    <ul class="menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a class="active">Admin Panel</a></li>
        <li><a href="donate.html">Donate Page</a></li>
    </ul>

    <a href="#" class="logout" id="logoutBtn">Logout</a>
</aside>

<!-- Main Content -->
<main class="content">
    <h1 class="title">Admin Panel</h1>
    <p class="subtitle">Manage announcements and donations</p>

    <!-- Add Announcement -->
    <div class="announcement-box">
        <h2>Add Announcement</h2>

        <input type="text" id="announcementTitle" placeholder="Title"
            style="width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd;">

        <textarea id="announcementText" placeholder="Announcement message"
            style="width:100%;padding:12px;height:100px;border-radius:8px;border:1px solid #ddd;"></textarea>

        <button class="action-btn" style="margin-top:15px;" onclick="addAnnouncement()">
            Post Announcement
        </button>
    </div>

    <div class="announcement-box" style="margin-top:40px;">
        <h2>Manage Announcements</h2>
        <div id="adminAnnouncements">Loading...</div>
    </div>


    <!-- Add Donation -->
    <div class="recent-activity" style="margin-top:40px;">
        <h2>Add Donation</h2>

        <input type="email" id="donationEmail" placeholder="User Email"
            style="width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd;">

        <input type="number" id="donationAmount" placeholder="Amount (â‚¹)"
            style="width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd;">

        <input type="text" id="donationNote" placeholder="Note (optional)"
            style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;">

        <button class="action-btn" style="margin-top:15px;" onclick="addDonation()">
            Add Donation
        </button>
    </div>
</main>

<script>


function addAnnouncement() {
    const title = document.getElementById("announcementTitle").value;
    const text = document.getElementById("announcementText").value;

    if (!title || !text) {
        alert("Please fill all fields");
        return;
    }

    fetch("https://ngo-backend-zmmx.onrender.com/api/announcements/add", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
        },

        body: JSON.stringify({ title, text })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        document.getElementById("announcementTitle").value = "";
        document.getElementById("announcementText").value = "";
    })
    .catch(err => alert("Error adding announcement"));
}


function addDonation() {
    const email = document.getElementById("donationEmail").value;
    const amount = document.getElementById("donationAmount").value;
    const note = document.getElementById("donationNote").value;

    if (!email || !amount) {
        alert("Email and amount required");
        return;
    }

    fetch("https://ngo-backend-zmmx.onrender.com/api/donations/add", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({ email, amount, note })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        document.getElementById("donationEmail").value = "";
        document.getElementById("donationAmount").value = "";
        document.getElementById("donationNote").value = "";
    })
    .catch(() => alert("Error adding donation"));
}


// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("user");
    window.location.href = "index.html";
});

function loadAdminAnnouncements() {
    fetch("https://ngo-backend-zmmx.onrender.com/api/announcements")
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("adminAnnouncements");
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<p>No announcements yet</p>";
                return;
            }

            data.forEach(a => {
                const div = document.createElement("div");
                div.style.borderBottom = "1px solid #ddd";
                div.style.padding = "10px 0";

                div.innerHTML = `
                    <strong>${a.title}</strong><br>
                    <p>${formatAnnouncementText(a.text)}</p>
                    <small>${new Date(a.createdAt).toDateString()}</small><br>
                    <button 
                        style="margin-top:8px;background:#ff4f7b;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer"
                        onclick="deleteAnnouncement('${a._id}')">
                        Delete
                    </button>
                `;

                container.appendChild(div);
            });
        });
}

function formatAnnouncementText(text) {
    if (!text) return "";

    // Convert URLs to clickable links
    const withLinks = text.replace(
        /(https?:\/\/[^\s]+)/g,
        url => `<a href="${url}" target="_blank" style="color:#ff4f7b;font-weight:600;">${url}</a>`
    );

    // Convert new lines to <br>
    return withLinks.replace(/\n/g, "<br>");
}



function deleteAnnouncement(id) {
    if (!confirm("Are you sure you want to delete this announcement?")) return;

    fetch(`https://ngo-backend-zmmx.onrender.com/api/announcements/${id}`, {
        method: "DELETE",
        headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
        }
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        loadAdminAnnouncements(); // refresh list
    })
    .catch(() => alert("Error deleting announcement"));
}

document.addEventListener("DOMContentLoaded", loadAdminAnnouncements);

</script>

</body>
</html>
